<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Firebase - Dulce Milagro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .json {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagn√≥stico Firebase - Dulce Milagro</h1>
        <p>Esta herramienta te ayuda a diagnosticar problemas con Firebase y permisos de usuario.</p>
        
        <div id="status"></div>
        
        <h2>üîç Verificaciones</h2>
        <button onclick="checkFirebaseConfig()">1. Verificar Configuraci√≥n Firebase</button>
        <button onclick="checkAuth()">2. Verificar Autenticaci√≥n</button>
        <button onclick="checkUserDoc()">3. Verificar Documento de Usuario</button>
        <button onclick="checkPermissions()">4. Verificar Permisos</button>
        <button onclick="checkFirestoreRules()">5. Probar Acceso a Firestore</button>
        
        <h2>‚ö° Acciones R√°pidas</h2>
        <button onclick="loginUser()">Simular Login</button>
        <button onclick="createUserDoc()" id="createDocBtn" style="display:none;">Crear Documento de Usuario</button>
        <button onclick="promoteToAdmin()" id="promoteBtn" style="display:none;">Promover a Admin</button>
        
        <div id="results"></div>
        
        <h2>üìã Instrucciones Manuales</h2>
        <div class="info">
            <strong>Si hay errores, puedes solucionarlos manualmente:</strong>
            <ol>
                <li>Ve a <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                <li>Selecciona tu proyecto</li>
                <li>Ve a Firestore Database</li>
                <li>Busca la colecci√≥n <code>users</code></li>
                <li>Encuentra tu documento de usuario</li>
                <li>Edita los campos <code>role</code> y <code>permissions</code></li>
            </ol>
        </div>
    </div>

    <script type="module">
        window.statusDiv = document.getElementById('status');
        window.resultsDiv = document.getElementById('results');
        
        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        window.checkFirebaseConfig = async function() {
            clearResults();
            try {
                // Intentar importar configuraci√≥n de Firebase
                const config = await import('./src/config/firebase.js');
                addResult('‚úÖ Configuraci√≥n Firebase', 'Firebase est√° correctamente configurado', 'success');
                
                if (config.auth) {
                    addResult('‚úÖ Auth', 'Servicio de autenticaci√≥n disponible', 'success');
                }
                
                if (config.db) {
                    addResult('‚úÖ Firestore', 'Base de datos Firestore disponible', 'success');
                }
                
            } catch (error) {
                addResult('‚ùå Error de Configuraci√≥n', `No se pudo cargar Firebase: ${error.message}`, 'error');
            }
        };
        
        window.checkAuth = async function() {
            try {
                const { getAuth } = await import('firebase/auth');
                const auth = getAuth();
                
                if (auth.currentUser) {
                    const user = auth.currentUser;
                    addResult('‚úÖ Usuario Autenticado', 
                        `Email: ${user.email}<br>UID: ${user.uid}<br>Nombre: ${user.displayName || 'No definido'}`, 
                        'success');
                    
                    document.getElementById('createDocBtn').style.display = 'inline-block';
                    document.getElementById('promoteBtn').style.display = 'inline-block';
                } else {
                    addResult('‚ùå No Autenticado', 'No hay usuario logueado', 'error');
                }
            } catch (error) {
                addResult('‚ùå Error Auth', error.message, 'error');
            }
        };
        
        window.checkUserDoc = async function() {
            try {
                const { getAuth } = await import('firebase/auth');
                const { doc, getDoc } = await import('firebase/firestore');
                const { db } = await import('./src/config/firebase.js');
                
                const auth = getAuth();
                if (!auth.currentUser) {
                    addResult('‚ùå No Autenticado', 'Debes estar logueado para verificar el documento', 'error');
                    return;
                }
                
                const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    addResult('‚úÖ Documento de Usuario', 
                        `<div class="json">${JSON.stringify(userData, null, 2)}</div>`, 
                        'success');
                } else {
                    addResult('‚ùå Documento No Existe', 
                        'El documento de usuario no existe en Firestore. Puedes crearlo con el bot√≥n "Crear Documento de Usuario"', 
                        'warning');
                }
                
            } catch (error) {
                addResult('‚ùå Error Firestore', `No se pudo acceder al documento: ${error.message}`, 'error');
            }
        };
        
        window.checkPermissions = async function() {
            try {
                const { getAuth } = await import('firebase/auth');
                const { doc, getDoc } = await import('firebase/firestore');
                const { db } = await import('./src/config/firebase.js');
                
                const auth = getAuth();
                if (!auth.currentUser) {
                    addResult('‚ùå No Autenticado', 'Debes estar logueado', 'error');
                    return;
                }
                
                const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const permissions = userData.permissions || {};
                    const role = userData.role || 'employee';
                    
                    let permissionsHTML = `<strong>Rol:</strong> ${role}<br><strong>Permisos:</strong><br>`;
                    Object.keys(permissions).forEach(key => {
                        const status = permissions[key] ? '‚úÖ' : '‚ùå';
                        permissionsHTML += `${status} ${key}: ${permissions[key]}<br>`;
                    });
                    
                    addResult('üìã Permisos Actuales', permissionsHTML, 'info');
                } else {
                    addResult('‚ùå Sin Permisos', 'No se encontr√≥ documento de usuario', 'error');
                }
                
            } catch (error) {
                addResult('‚ùå Error Permisos', error.message, 'error');
            }
        };
        
        window.checkFirestoreRules = async function() {
            try {
                const { collection, getDocs, limit, query } = await import('firebase/firestore');
                const { db } = await import('./src/config/firebase.js');
                
                // Intentar leer algunos documentos para probar las reglas
                const testQuery = query(collection(db, 'users'), limit(1));
                const querySnapshot = await getDocs(testQuery);
                
                addResult('‚úÖ Reglas Firestore', 'Las reglas permiten lectura de usuarios', 'success');
                
            } catch (error) {
                addResult('‚ùå Reglas Firestore', 
                    `Error al acceder: ${error.message}<br>Verifica las reglas de seguridad en Firebase Console`, 
                    'error');
            }
        };
        
        window.createUserDoc = async function() {
            try {
                const { getAuth } = await import('firebase/auth');
                const { doc, setDoc } = await import('firebase/firestore');
                const { db } = await import('./src/config/firebase.js');
                
                const auth = getAuth();
                if (!auth.currentUser) {
                    addResult('‚ùå No Autenticado', 'Debes estar logueado', 'error');
                    return;
                }
                
                const user = auth.currentUser;
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || '',
                    role: 'employee',
                    permissions: {
                        dashboard: true,
                        inventory: false,
                        purchases: false,
                        sales: true,
                        salesHistory: false,
                        purchasesHistory: false,
                        layaway: true,
                        customers: true,
                        categories: true,
                        reports: false,
                        userManagement: false,
                    },
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, 'users', user.uid), userData);
                
                addResult('‚úÖ Documento Creado', 'Documento de usuario creado como empleado', 'success');
                
            } catch (error) {
                addResult('‚ùå Error Creaci√≥n', error.message, 'error');
            }
        };
        
        window.promoteToAdmin = async function() {
            try {
                const { getAuth } = await import('firebase/auth');
                const { doc, updateDoc } = await import('firebase/firestore');
                const { db } = await import('./src/config/firebase.js');
                
                const auth = getAuth();
                if (!auth.currentUser) {
                    addResult('‚ùå No Autenticado', 'Debes estar logueado', 'error');
                    return;
                }
                
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    role: 'admin',
                    permissions: {
                        dashboard: true,
                        inventory: true,
                        purchases: true,
                        sales: true,
                        salesHistory: true,
                        purchasesHistory: true,
                        layaway: true,
                        customers: true,
                        categories: true,
                        reports: true,
                        userManagement: true,
                    },
                    updatedAt: new Date().toISOString()
                });
                
                addResult('‚úÖ Promovido a Admin', 'Usuario promovido exitosamente. Recarga la p√°gina para ver los cambios.', 'success');
                
            } catch (error) {
                addResult('‚ùå Error Promoci√≥n', 
                    `${error.message}<br><br>üí° <strong>Soluci√≥n:</strong> Ve a Firebase Console y edita manualmente el documento`, 
                    'error');
            }
        };
        
        window.loginUser = function() {
            addResult('üí° Login Manual', 
                'Para esta herramienta, debes estar logueado en la aplicaci√≥n principal primero.<br>' +
                '1. Ve a tu aplicaci√≥n principal<br>' +
                '2. Inicia sesi√≥n<br>' +
                '3. Regresa a esta p√°gina y verifica tu estado', 
                'info');
        };
    </script>
</body>
</html>
